name: Nao Nanami Autonomy System

on:
  # å®šæœŸå®Ÿè¡Œï¼ˆ2æ—¥ã«1å›ï¼‰
  schedule:
    - cron: '0 0 */2 * *'
  # æ‰‹å‹•å®Ÿè¡Œç”¨
  workflow_dispatch:
    inputs:
      initiative_type:
        description: 'è‡ªå¾‹æ´»å‹•ã®ç¨®é¡'
        required: true
        default: 'random'
        type: choice
        options:
          - random
          - question
          - reflection
          - idea
          - story
          - meta_reflection
      priority:
        description: 'å„ªå…ˆåº¦'
        required: true
        default: 'medium'
        type: choice
        options:
          - low
          - medium
          - high

# åŒæ™‚å®Ÿè¡Œã‚’é˜²æ­¢ã™ã‚‹è¨­å®š
concurrency:
  group: repo-operations
  cancel-in-progress: true

# GitHub Actionsã«æ›¸ãè¾¼ã¿æ¨©é™ã‚’ä»˜ä¸
permissions:
  contents: write
  issues: write

jobs:
  generate-autonomous-activity:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # ã™ã¹ã¦ã®å±¥æ­´ã‚’å–å¾—
          token: ${{ secrets.GITHUB_TOKEN }}  # æ˜ç¤ºçš„ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æŒ‡å®š

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          npm init -y
          npm install @octokit/rest moment yaml front-matter lodash natural uuid

      - name: Create config directories
        run: |
          mkdir -p .github/config
          mkdir -p .github/temp
          mkdir -p memory/graph

      - name: Analyze repository content
        id: analyze
        run: |
          node .github/scripts/analyze-content.js
          echo "analysis_complete=true" >> $GITHUB_OUTPUT

      - name: Run memory maintenance
        id: memory_maintenance
        run: |
          node -e "
            const memoryManager = require('./.github/scripts/memory-manager.js');
            async function main() {
              const count = await memoryManager.runMemoryMaintenance();
              console.log(\`è¨˜æ†¶æ•´ç†å®Œäº†: \${count}ä»¶ã®è¨˜æ†¶ã‚’æ•´ç†ã—ã¾ã—ãŸ\`);
            }
            main().catch(console.error);
          "

      - name: Generate autonomous content
        id: generate
        run: |
          # ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç”Ÿæˆ
          node .github/scripts/generate-content.js
          
          # æ—¥æ™‚ãƒ™ãƒ¼ã‚¹ã®ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆ
          TIMESTAMP=$(date +"%Y-%m-%d %H:%M")
          DEFAULT_TITLE="ä¸ƒæµ·ç›´ã®æ€è€ƒ: ${TIMESTAMP}"
          
          # ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
          if [ -f "./.github/temp/autonomy-content.md" ]; then
            # ãƒ•ã‚¡ã‚¤ãƒ«ã®å…ˆé ­ã‹ã‚‰ã‚¿ã‚¤ãƒˆãƒ«ã‚’æŠ½å‡ºï¼ˆMarkdownã®æœ€åˆã®è¦‹å‡ºã—ï¼‰
            EXTRACTED_TITLE=$(head -n 20 ./.github/temp/autonomy-content.md | grep "^# " | head -n 1 | sed 's/^# //')
            
            if [ ! -z "$EXTRACTED_TITLE" ]; then
              echo "THOUGHT_TITLE=${EXTRACTED_TITLE}" >> $GITHUB_ENV
              echo "ã‚¿ã‚¤ãƒˆãƒ«ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æŠ½å‡º: ${EXTRACTED_TITLE}"
            else
              echo "THOUGHT_TITLE=${DEFAULT_TITLE}" >> $GITHUB_ENV
              echo "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ã‚¤ãƒˆãƒ«ã‚’ä½¿ç”¨: ${DEFAULT_TITLE}"
            fi
            
            echo "content_generated=true" >> $GITHUB_OUTPUT
          else
            echo "ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "content_generated=false" >> $GITHUB_OUTPUT
          fi
        env:
          INITIATIVE_TYPE: ${{ github.event.inputs.initiative_type || 'random' }}
          PRIORITY: ${{ github.event.inputs.priority || 'medium' }}

      # Issueãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™
      - name: Prepare issue file
        if: steps.generate.outputs.content_generated == 'true'
        run: |
          # Issueç”¨ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™
          cp ./.github/temp/autonomy-content.md /tmp/issue-content.md

      - name: Create autonomy issue
        if: steps.generate.outputs.content_generated == 'true'
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: "${{ env.THOUGHT_TITLE }}"
          content-filepath: /tmp/issue-content.md
          labels: |
            autonomy
            thought
            ${{ github.event.inputs.priority || 'medium' }}
          token: ${{ secrets.GITHUB_TOKEN }}

      # ä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ä¿å­˜
      - name: Save generated content
        if: steps.generate.outputs.content_generated == 'true'
        run: |
          mkdir -p /tmp/nao_autonomy
          
          # ç”Ÿæˆã•ã‚ŒãŸå†…å®¹ã‚’ä¿å­˜
          if [ -f "./.github/temp/autonomy-content.md" ]; then
            cp ./.github/temp/autonomy-content.md /tmp/nao_autonomy/
          fi
      
      # æœ€æ–°ã®å¤‰æ›´ã‚’å–å¾—ã—ã¦åŒæœŸ
      - name: Sync with latest changes
        if: steps.generate.outputs.content_generated == 'true'
        run: |
          git config --local user.name 'Nao Nanami (Automated)'
          git config --local user.email 'nao-amj@users.noreply.github.com'
          git fetch --all
          git reset --hard origin/main
      
      # ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å¾©å…ƒã—ã¦è¿½åŠ 
      - name: Restore and commit generated content
        if: steps.generate.outputs.content_generated == 'true'
        run: |
          if [ -f "/tmp/nao_autonomy/autonomy-content.md" ]; then
            # å›ºå®šã®å€¤ã‚’ä½¿ç”¨
            CATEGORY="general"
            FILENAME="thought_$(date +"%Y%m%d%H%M%S").md"
            
            # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆã¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚³ãƒ”ãƒ¼
            mkdir -p dreams/$CATEGORY
            cp /tmp/nao_autonomy/autonomy-content.md dreams/$CATEGORY/$FILENAME
            
            # å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
            git add dreams/
            git commit -m "ğŸŒ± ä¸ƒæµ·ç›´ã®è‡ªå¾‹çš„æ€è€ƒ: ${{ env.THOUGHT_TITLE || 'New Thought' }}" --allow-empty || echo "No changes to commit"
            
            # ãƒ—ãƒƒã‚·ãƒ¥å‡¦ç†
            git push origin main || git push --force origin main
          else
            echo "No generated content found, skipping commit"
          fi
