name: Memory Indexer and Graph Maintenance

on:
  push:
    paths:
      - 'memory/**'
      - 'theory/**'
      - 'signals/**'
      - 'shells/**'
      - 'dreams/**'
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:

# GitHub Actionsã«æ›¸ãè¾¼ã¿æ¨©é™ã‚’ä»˜ä¸
permissions:
  contents: write

jobs:
  update-memory-index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: |
          npm init -y
          npm install @octokit/rest moment yaml front-matter lodash natural uuid
          
      - name: Install Python dependencies
        run: |
          pip install markdown pyyaml
          
      - name: Update memory index
        run: |
          # å¾“æ¥ã®Pythonç‰ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ›´æ–°ï¼ˆäº’æ›æ€§ã®ãŸã‚ï¼‰
          python scripts/update_memory_index.py
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Update memory graph
        run: |
          mkdir -p .github/config
          mkdir -p memory/graph
          
          # è¨˜æ†¶ã‚°ãƒ©ãƒ•ã®æ›´æ–°
          node -e "
            const memoryManager = require('./.github/scripts/memory-manager.js');
            const fs = require('fs');
            const path = require('path');
            
            async function updateGraph() {
              // è¨˜æ†¶ã‚°ãƒ©ãƒ•ã‚’å–å¾—
              const graph = await memoryManager.getMemoryGraph();
              
              // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰è¨˜æ†¶ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
              const dirs = ['memory', 'dreams', 'signals', 'shells', 'theory'];
              let newMemories = 0;
              
              for (const dir of dirs) {
                if (!fs.existsSync(dir)) continue;
                await processDirectory(dir, graph);
              }
              
              // è¨˜æ†¶ã‚°ãƒ©ãƒ•ã‚’ä¿å­˜
              await memoryManager.saveMemoryGraph(graph);
              console.log('è¨˜æ†¶ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
            }
            
            async function processDirectory(dir, graph) {
              const files = fs.readdirSync(dir, { withFileTypes: true });
              
              for (const file of files) {
                const fullPath = path.join(dir, file.name);
                
                if (file.isDirectory()) {
                  await processDirectory(fullPath, graph);
                } else if (file.name.endsWith('.md')) {
                  const content = fs.readFileSync(fullPath, 'utf8');
                  // æ—¢ã«å‡¦ç†æ¸ˆã¿ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¿ã‘ã‚‹ãŸã‚ã®ç°¡æ˜“ãƒã‚§ãƒƒã‚¯
                  const memoryId = path.basename(fullPath, '.md');
                  
                  // æ–°ã—ã„è¨˜æ†¶ã¨ã—ã¦è¿½åŠ 
                  await memoryManager.addNewMemory(content, {
                    source: fullPath,
                    type: 'file',
                    automatic: false,
                    persistent: true
                  });
                }
              }
            }
            
            updateGraph().catch(console.error);
          "
          
      - name: Commit and push updated index
        run: |
          git config --local user.email "nao-bot@example.com"
          git config --local user.name "Nao Memory Indexer"
          git add memory/index.json meta/memory_stats.json memory/graph/memory-graph.json
          git commit -m "ğŸ”„ è¨˜æ†¶ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ›´æ–°: $(date +%Y-%m-%d)" || echo "No changes to commit"
          git push
